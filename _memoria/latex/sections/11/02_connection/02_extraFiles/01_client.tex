\subsubsection{El client de FamilySearch}

\paragraph{}
Pel fet que es va decidir interactuar amb l'API de FamilySearch, des de la capa Controlador de la pàgina web, ens trobem en la situació d'haver de crear una instància del client cada cop que l'usuari canvia de pàgina.

Això és degut al fet que quan el navegador canvia d'URL, també neteja el conjunt de variables globals declarades en els fitxers Javascript. De totes maneres, això no vol dir que l'usuari s'hagi d'identificar de nou, cada cop que canvia de pàgina.

El fitxer, client.js, és l'encarregat de crear les instàncies del client i gestionar la concordança d'estat, entre la connexió a FamilySearch i la informació emmagatzemada en el nostre servidor. Recordem, que el servidor és el que decideix si l'usuari pot accedir i utilitzar els exemples i que per tant, esdevé important mantenir aquesta concordança d'estat en tot moment.

A pesar que els usuaris només necessiten estar identificats a les pàgines d'exemples, el fet de voler oferir la possibilitat de desconnexió des de qualsevol punt de l'aplicació, el fitxer \emph{client.js} s'adjunta a totes les pàgines del domini web.

Les instàncies del client FamilySearch són declarades a cada pàgina mitjançant la funció, \emph{new Familysearch()}, proporcionada pel Javascript SDK.

\begin{lstlisting}[style=rawOwn,caption={Creació d'una instància del client FamilySearch}]
var client = new FamilySearch({
    client_id: `a02j000000E5DXqAAN',
    redirect_uri: document.location.protocol + `//' + document.location.host + `/',
    save_access_token: saveCookie,
    access_token: token,
    auto_expire: true,
    auto_signin: true,
    expire_callback: function(data) { ... },
    environment: `sandbox'
});
\end{lstlisting}

Els paràmetres inclosos en la creació de la instància del client, compleixen les següents funcions:

\begin{itemize}
    \item \textbf{client\_id:} Número del client, que identifica l'aplicació, a la plataforma de desenvolupadors de FamilySearch. Diferent per cada aplicació.
    \item \textbf{redirect\_uri:} URL de redirecció registrada a la plataforma de desenvolupadors de FamilySearch, per indicar el punt de retorn pel procés d'identificació.
    \item \textbf{save\_access\_token:} Variable que permet emmagatzemar el `token' retornat per l'API, en el procés d'identificació, en una galeta del navegador. Aquesta permet crear instàncies del client a totes les pàgines del domini web, sense la necessitat d'anar demanant a l'usuari que s'identifiqui. En el nostre cas, es tracta d'un booleà que contindrà el valor false quasi sempre, ja que utilitzem un mètode alternatiu per emmagatzemar el `token' d'accés, de forma que compleixi amb els requisits de certificació.
    \item \textbf{test\_token:} En cas que l'usuari ja es trobi identificat amb FamilySearch, li passem el `token' emmagatzemant de forma automàtica. Això ens permet no haver de demanar a l'usuari que s'identifiqui a cada una de les pàgines de l'aplicació web.
    \item \textbf{auto\_expire:} Booleà que indica si volem que el sistema netegi el `token' de forma automàtica en cas que aquest quedi invalidat.
    \item \textbf{auto\_signin:} Booleà que indica si volem que es demani a l'usuari que s'identifiqui cada cop que intenta realitzar una operació contra l'API sense trobar-se connectat a FamilySearch. En la nostra aplicació, li passem el paràmetre true, de totes maneres, no s'hauria de poder donar el cas en què un usuari pogués llençar una crida contra l'API sense trobar-se identificat. L'utilitzem, simplement, com a mesura de seguretat.
    \item \textbf{expire\_callback:} Funció a executar quan el `token' expira. Conté quasi el mateix codi que la funció de desconnexió implementada, així que veurem el seu compartament més endavant.
    \item \textbf{environment:} Entorn de l'API de FamilySearch en el que ens volem connectar: `production', `sandbox', `beta', etcètera.
\end{itemize}

Fins aquí, tot és relativament simple, però on s'emmagatzema el `token' per complir amb les regles de certificació i poder reutilitzar-lo? La resposta és a l'espai local del navegador. Els navegadors moderns permeten escriure en el que es coneix com l'espai local del navegador, el mateix lloc, on els navegadors emmagatzemen les imatges i recursos d'una aplicació web per tal de reutilitzar-los en futures crides, evitant així, haver de descarregar-los de nou i augmentar la velocitat de càrrega.

S'utilitza l'espai local del navegador per emmagatzemar el `token', ja que és un espai inaccessible per tercers i dificulta, en gran mesura, el robament d'identitat.

Al principi del fitxer \emph{client.js} es comprova si el navegador utilitzat per l'usuari suporta l'escriptura a l'espai local. En cas afirmatiu, es carrega el `token' emmagatzema't, si aquest existeix, en el paràmetre \emph{token}. Altrament, es configura el paràmetre \emph{save\_access\_token} amb el valor true.

Aquests dos paràmetres, són els mateixos que s'utilitzen en la creació del client, descrita en el bloc de codi anterior. A continuació, mostrem el bloc de codi que configura els paràmetres \emph{save\_access\_token} i \emph{token}.

\begin{lstlisting}[style=rawOwn,caption={Configuració dels paràmetres \emph{access\_test\_token} i \emph{token}}]
if (typeof(Storage) !== `undefined') {
    token = localStorage.token ? localStorage.token : `';
} else {
    saveCookie = true;
}
\end{lstlisting}
